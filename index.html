<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cattle Farm Viability Assessment - Bank Grade</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .wrapper {
            display: flex;
            min-height: 100vh;
        }
        /* Desktop sidebar styles */
        .sidebar {
            width: 280px;
            background-color: #343a40;
            color: #fff;
            padding: 20px;
            flex-shrink: 0;
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar .nav-link {
            color: #adb5bd;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: background-color 0.3s, color 0.3s;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: #495057;
            color: #fff;
        }
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        .content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }
        .header {
            background-color: #fff;
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .header .logo {
            height: 40px;
            margin-right: 15px;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #007bff;
            color: #fff;
            border-bottom: none;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            border-radius: 8px;
            padding: 10px 20px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            border-radius: 8px;
            padding: 10px 20px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #5a6268;
        }
        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000;
            border-radius: 8px;
            padding: 10px 20px;
        }
        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #d39e00;
        }
        .progress-bar {
            border-radius: 5px;
        }
        .status-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #28a745;
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        .status-panel.error {
            background-color: #dc3545;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }
        .loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007bff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .score-input {
            width: 80px;
            display: inline-block;
            margin-left: 10px;
        }
        .list-group-item-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Mobile-first adjustments */
        @media (max-width: 767.98px) {
            .wrapper {
                flex-direction: column;
            }
            .sidebar {
                display: none;
            }
            .content {
                padding: 15px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }
            .header .logo-section {
                width: 100%;
                justify-content: space-between;
                margin-bottom: 10px;
            }
            .header .farm-selector-section {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
            }
            .header .farm-selector-section .form-select {
                width: 100%;
                margin-bottom: 10px;
            }
            .header .farm-selector-section .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            .header .farm-selector-section .btn:last-child {
                margin-bottom: 0;
            }

            .offcanvas {
                background-color: #343a40;
                color: #fff;
            }
            .offcanvas .nav-link {
                color: #adb5bd;
                padding: 10px 15px;
                border-radius: 8px;
                margin-bottom: 5px;
                transition: background-color 0.3s, color 0.3s;
            }
            .offcanvas .nav-link:hover, .offcanvas .nav-link.active {
                background-color: #495057;
                color: #fff;
            }
            .offcanvas-header {
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
            .offcanvas-title {
                color: #fff;
            }
            .btn-close {
                filter: invert(1) grayscale(100%) brightness(200%);
            }
        }

        @media (min-width: 768px) {
            .hamburger-menu-button {
                display: none !important;
            }
        }

        .report-section {
            margin-bottom: 2rem;
            page-break-inside: avoid;
        }
        .report-section-title {
            font-size: 14pt;
            font-weight: bold;
            margin-bottom: 1rem;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
        }
        .report-narrative {
            line-height: 1.6;
            margin-bottom: 1rem;
        }
    </style>

    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <div class="wrapper">
        <nav class="sidebar d-none d-md-block">
            <h4 class="text-white mb-4">Assessment Modules</h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-module="executive-summary">
                        <i class="fas fa-chart-line"></i> Executive Summary
                        <span class="float-end badge bg-secondary" id="progress-executive-summary">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="business-description">
                        <i class="fas fa-building"></i> Business Description
                        <span class="float-end badge bg-secondary" id="progress-business-description">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="financial-assessment">
                        <i class="fas fa-dollar-sign"></i> Financial Assessment
                        <span class="float-end badge bg-secondary" id="progress-financial-assessment">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="commercial-marketing">
                        <i class="fas fa-store"></i> Commercial & Marketing
                        <span class="float-end badge bg-secondary" id="progress-commercial-marketing">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="hr-management">
                        <i class="fas fa-users"></i> HR Management
                        <span class="float-end badge bg-secondary" id="progress-hr-management">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="environmental-assessment">
                        <i class="fas fa-leaf"></i> Environmental
                        <span class="float-end badge bg-secondary" id="progress-environmental-assessment">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="legal-regulatory">
                        <i class="fas fa-gavel"></i> Legal & Regulatory
                        <span class="float-end badge bg-secondary" id="progress-legal-regulatory">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="agricultural-technical">
                        <i class="fas fa-tractor"></i> Agricultural Technical
                        <span class="float-end badge bg-secondary" id="progress-agricultural-technical">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="risk-analysis">
                        <i class="fas fa-exclamation-triangle"></i> Risk Analysis
                        <span class="float-end badge bg-secondary" id="progress-risk-analysis">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="scoring-classification">
                        <i class="fas fa-star"></i> Scoring & Classification
                        <span class="float-end badge bg-secondary" id="progress-scoring-classification">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="viability-conclusion">
                        <i class="fas fa-check-circle"></i> Viability Conclusion
                        <span class="float-end badge bg-secondary" id="progress-viability-conclusion">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="reporting-system">
                        <i class="fas fa-file-pdf"></i> Comprehensive Report
                        <span class="float-end badge bg-secondary" id="progress-reporting-system">0%</span>
                    </a>
                </li>
                <li class="nav-item mt-4 pt-3 border-top">
                    <a class="nav-link" href="#" id="exportDataBtn">
                        <i class="fas fa-download"></i> Export Data
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="importDataBtn">
                        <i class="fas fa-upload"></i> Import (Restore)
                    </a>
                </li>
            </ul>
        </nav>

        <div class="content">
            <div class="header">
                <div class="logo-section d-flex align-items-center">
                    <h2 class="mb-0">Farm Viability Assessment</h2>
                    <button class="btn btn-secondary hamburger-menu-button d-md-none ms-auto" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <div class="farm-selector-section d-flex align-items-center gap-2 mt-3 mt-md-0">
                    <select class="form-select" id="farmSelector" style="max-width: 250px;">
                        <option value="">Select a Farm</option>
                    </select>
                    <button class="btn btn-primary" id="newFarmBtn"><i class="fas fa-plus"></i> New Farm</button>
                    <button class="btn btn-danger" id="deleteFarmBtn"><i class="fas fa-trash"></i> Delete</button>
                    <button class="btn btn-warning" id="emergencyRecoveryBtn"><i class="fas fa-file-export"></i> Recovery</button>
                </div>
            </div>

            <div id="moduleContent"></div>
        </div>
    </div>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasSidebar">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Assessment Modules</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-module="executive-summary">
                        <i class="fas fa-chart-line"></i> Executive Summary
                        <span class="float-end badge bg-secondary" id="progress-executive-summary-mobile">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="business-description">
                        <i class="fas fa-building"></i> Business Description
                        <span class="float-end badge bg-secondary" id="progress-business-description-mobile">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="financial-assessment">
                        <i class="fas fa-dollar-sign"></i> Financial Assessment
                        <span class="float-end badge bg-secondary" id="progress-financial-assessment-mobile">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="commercial-marketing">
                        <i class="fas fa-store"></i> Commercial & Marketing
                        <span class="float-end badge bg-secondary" id="progress-commercial-marketing-mobile">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="hr-management">
                        <i class="fas fa-users"></i> HR Management
                        <span class="float-end badge bg-secondary" id="progress-hr-management-mobile">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="environmental-assessment">
                        <i class="fas fa-leaf"></i> Environmental
                        <span class="float-end badge bg-secondary" id="progress-environmental-assessment-mobile">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="legal-regulatory">
                        <i class="fas fa-gavel"></i> Legal & Regulatory
                        <span class="float-end badge bg-secondary" id="progress-legal-regulatory-mobile">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="agricultural-technical">
                        <i class="fas fa-tractor"></i> Agricultural Technical
                        <span class="float-end badge bg-secondary" id="progress-agricultural-technical-mobile">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="risk-analysis">
                        <i class="fas fa-exclamation-triangle"></i> Risk Analysis
                        <span class="float-end badge bg-secondary" id="progress-risk-analysis-mobile">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="scoring-classification">
                        <i class="fas fa-star"></i> Scoring & Classification
                        <span class="float-end badge bg-secondary" id="progress-scoring-classification-mobile">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="viability-conclusion">
                        <i class="fas fa-check-circle"></i> Viability Conclusion
                        <span class="float-end badge bg-secondary" id="progress-viability-conclusion-mobile">0%</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-module="reporting-system">
                        <i class="fas fa-file-pdf"></i> Comprehensive Report
                        <span class="float-end badge bg-secondary" id="progress-reporting-system-mobile">0%</span>
                    </a>
                </li>
                <li class="nav-item mt-4 pt-3 border-top">
                    <a class="nav-link" href="#" id="exportDataBtnMobile">
                        <i class="fas fa-download"></i> Export Data
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="importDataBtnMobile">
                        <i class="fas fa-upload"></i> Import (Restore)
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <input type="file" id="importFileInput" accept=".json" style="display: none;">

    <div class="status-panel" id="statusPanel"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ============================================
        // PERSISTENCE AND INITIALIZATION
        // ============================================
        
        const LOCALSTORAGE_LAST_FARM_ID = 'lastUsedFarmId';
        const DB_NAME = 'CattleFarmDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'farmAssessments';

        let allFarmIds = [];
        let currentFarmId = null;
        let farmAssessmentData = {};
        let supabaseClient = null;

        // ============================================
        // CONSTANTS & CONFIGURATION (FROM VERSION 39)
        // ============================================

        const OPTIONS = {
            farmType: { 'Beef': 100, 'Dairy': 90, 'Mixed': 80, 'Other': 50 },
            landTenure: { 'Owned': 100, 'Leased': 70, 'Mixed': 85 },
            legalStructure: { 'Pty Ltd': 100, 'Co-op': 90, 'Sole Prop': 70, 'Trust': 80, 'Partnership': 60, 'Individual': 50, 'CC': 75 },
            condition: { 'Excellent': 100, 'Good': 75, 'Fair': 50, 'Poor': 25 }, 
            identificationSystem: { 'RFID': 100, 'Ear Tags': 70, 'Branding': 40, 'None': 10 },
            herdHealthStatus: { 'Excellent': 100, 'Good': 75, 'Fair': 50, 'Poor': 25 },
            relationshipStrength: { 'Strong': 100, 'Moderate': 70, 'Weak': 30 },
            marketingPlanEvaluation: { 'Effective': 100, 'Needs Improvement': 50, 'Lacking': 20 },
            pricingStrategy: { 'Competitive': 100, 'Premium': 90, 'Cost-Plus': 70, 'Undifferentiated': 40 },
            organizationalChart: { 'Available': 100, 'Not Available': 0 },
            roleClarity: { 'Very Clear': 100, 'Clear': 75, 'Somewhat Clear': 50, 'Unclear': 25 },
            successionPlanning: { 'In Place': 100, 'Developing': 60, 'None': 20 },
            unionRelationships: { 'Harmonious': 100, 'Stable': 70, 'Occasional Disputes': 40, 'Frequent Disputes': 10 },
            environmentalAudits: { 'Annually': 100, 'Biennially': 70, 'Irregularly': 30, 'Never': 0 },
            complianceStatus: { 'Fully Compliant': 100, 'Minor Issues': 60, 'Non-Compliant': 20 },
            safetyProtocols: { 'Documented & Implemented': 100, 'Documented': 60, 'Lacking': 20, 'None': 0 },
            waterUsageMonitoring: { 'Monitored & Optimized': 100, 'Monitored': 70, 'Not Monitored': 30 },
            carbonFootprint: { 'Assessed & Reduced': 100, 'Assessed': 60, 'Not Assessed': 0 },
            registrationStatus: { 'Active': 100, 'Dormant': 50, 'Lapsed': 0 },
            directorCompliance: { 'Yes': 100, 'No': 0 },
            regulatoryStandardsCompliance: { 'Yes': 100, 'Partial': 50, 'No': 0 },
            taxCompliance: { 'Yes': 100, 'No': 0 }, 
            coverageAdequacy: { 'Adequate': 100, 'Gaps Identified': 50, 'Inadequate': 0 },
            soilPotential: { 'High': 100, 'Medium': 70, 'Low': 30 },
            waterAvailability: { 'Abundant': 100, 'Sufficient': 70, 'Limited': 30, 'Scarce': 0 },
            breedSelection: { 'Optimized': 100, 'Standard': 70, 'Suboptimal': 30 },
            integratedNutritionSystems: { 'Optimized': 100, 'Standard': 70, 'Basic': 30 },
            grazingManagement: { 'Rotational': 100, 'Semi-Rotational': 70, 'Continuous': 30 },
            veterinaryPrograms: { 'Comprehensive': 100, 'Basic Preventive': 70, 'Reactive': 30, 'None': 0 },
            automationLevel: { 'High': 100, 'Medium': 70, 'Low': 40, 'None': 10 },
            precisionAgriculture: { 'Yes': 100, 'No': 0 },
            renewableEnergy: { 'Yes': 100, 'Partial': 50, 'No': 0 },
            swotStrengths: {
                'Strong Management Team': 10, 'High-Quality Livestock': 10, 'Modern Infrastructure & Equipment': 8,
                'Established Market Access': 8, 'Diversified Revenue Streams': 7, 'Efficient Production Practices': 7,
                'Healthy Financial Position': 9, 'Experienced Labor Force': 6, 'Strong Brand Reputation': 5,
                'Robust Disease Prevention': 9, 'Sustainable Water Management': 8
            },
            swotWeaknesses: {
                'Aging Infrastructure': -8, 'High Operating Costs': -9, 'Lack of Succession Planning': -10,
                'Limited Market Access': -7, 'Dependence on Single Commodity': -8, 'Poor Herd Health Management': -10,
                'High Debt Burden': -10, 'Inexperienced Labor Force': -7, 'Weak Financial Controls': -9,
                'Inefficient Waste Management': -7, 'Limited Access to Capital': -9
            },
            swotOpportunities: {
                'Expanding Local Market Demand': 9, 'Access to New Technologies': 8, 'Government Support Programs': 7,
                'Value-Added Product Development': 10, 'Export Market Expansion': 9, 'Strategic Partnerships': 8,
                'Improved Climate Resilience': 6, 'Sustainable Farming Practices Adoption': 7,
                'Growing Organic/Ethical Meat Market': 8, 'Improved Genetics & Breeding': 7
            },
            swotThreats: {
                'Adverse Weather Conditions': -10, 'Fluctuating Commodity Prices': -9, 'Increased Competition': -7,
                'Disease Outbreaks': -10, 'Rising Input Costs': -8, 'Regulatory Changes': -7,
                'Land Reform Uncertainty': -9, 'Labor Shortages': -8, 'Water Scarcity': -9,
                'Consumer Preference Shifts': -6, 'Trade Barriers': -7
            }
        };

        const COMPONENT_WEIGHTS = {
            financial: 0.25,
            operational: 0.20,
            market: 0.20,
            management: 0.15,
            compliance: 0.10,
            agricultural: 0.10
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showStatus(message, isError = false) {
            const panel = document.getElementById('statusPanel');
            panel.textContent = message;
            panel.classList.toggle('error', isError);
            panel.style.display = 'block';
            setTimeout(() => {
                panel.style.display = 'none';
            }, 3000);
        }

        function generateUniqueId() {
            return 'farm_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Helper to get nested property value safely (from ver 39)
        function getNestedValue(obj, path, defaultValue = '') {
            const parts = path.split('.');
            let current = obj;
            for (let i = 0; i < parts.length; i++) {
                if (current === null || typeof current !== 'object' || !current.hasOwnProperty(parts[i])) {
                    return defaultValue;
                }
                current = current[parts[i]];
            }
            return current;
        }

        // ============================================
        // INDEXEDDB FUNCTIONS
        // ============================================

        async function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'farmId' });
                    }
                };
            });
        }

        async function saveFarmDataIndexedDB(farmId, data) {
            const db = await openIndexedDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put({ farmId, data });
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }

        async function loadFarmDataIndexedDB(farmId) {
            const db = await openIndexedDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(farmId);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result ? request.result.data : null);
            });
        }

        async function getAllFarmIdsIndexedDB() {
            const db = await openIndexedDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAllKeys();
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result || []);
            });
        }

        async function deleteFarmDataIndexedDB(farmId) {
            const db = await openIndexedDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(farmId);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }

        // ============================================
        // PERSISTENCE: SAVE AND RESTORE LAST USED FARM
        // ============================================

        function saveLastUsedFarmId(farmId) {
            localStorage.setItem(LOCALSTORAGE_LAST_FARM_ID, farmId);
        }

        function getLastUsedFarmId() {
            return localStorage.getItem(LOCALSTORAGE_LAST_FARM_ID);
        }

        function clearLastUsedFarmId() {
            localStorage.removeItem(LOCALSTORAGE_LAST_FARM_ID);
        }

        // ============================================
        // DEFAULT DATA STRUCTURE
        // ============================================

        const defaultFarmAssessmentData = {
            farmProfile: {
                basicInfo: {
                    farmId: '',
                    farmName: '',
                    totalHectares: 0,
                    location: '',
                    landTenure: '',
                    registrationStatus: ''
                },
                legalStructure: '',
                infrastructure: {
                    buildings: [{ type: '', condition: '', value: 0 }],
                    equipment: [{ type: '', condition: '', value: 0 }],
                    totalInfrastructureValue: 0
                },
                coreActivities: {
                    primaryCommodities: [],
                    livestockTypes: [],
                    valueChainPosition: ''
                },
                herdDetails: {
                    totalHead: 0,
                    averageValuePerHead: 0,
                    breedingCows: 0,
                    bulls: 0,
                    calves: 0,
                    mainBreeds: [],
                    herdHealthStatus: '',
                    identificationSystem: ''
                }
            },
            financialAssessment: {
                historicalData: {
                    year1: { revenue: 0, operatingCosts: 0, capitalExpenditure: 0, totalAssets: 0, totalLiabilities: 0, netIncome: 0, ebit: 0, interestExpense: 0, currentAssets: 0, currentLiabilities: 0, inventory: 0 },
                    year2: { revenue: 0, operatingCosts: 0, capitalExpenditure: 0, totalAssets: 0, totalLiabilities: 0, netIncome: 0, ebit: 0, interestExpense: 0, currentAssets: 0, currentLiabilities: 0, inventory: 0 },
                    year3: { revenue: 0, operatingCosts: 0, capitalExpenditure: 0, totalAssets: 0, totalLiabilities: 0, netIncome: 0, ebit: 0, interestExpense: 0, currentAssets: 0, currentLiabilities: 0, inventory: 0 }
                },
                workingCapital: { requirementsAnalysis: '', seasonalVariations: '', cashConversionCycle: 0 },
                capitalExpenditure: { investmentNeeds: '', deferredExpenditures: '', infrastructureRequirements: '' },
                assetEvaluation: { tangibleAssetCondition: '', depreciationAnalysis: '', marketValueAssessment: '' },
                debtAnalysis: { outstandingIndebtedness: 0, ownerGuarantees: '', repaymentSchedules: [] },
                ageAnalysis: { accountsReceivableAging: '', accountsPayableAging: '', collectionEfficiency: 0 },
                budgetAnalysis: { capitalBudgetAppropriateness: '', operatingBudgetAppropriateness: '', varianceAnalysis: '' },
                seasonalityAssessment: { revenueSeasonalPatterns: '', workingCapitalSeasonalPatterns: '' },
                financialProjections: { integratedModelAssumptions: '', scenarioAnalysis: '' },
                breakEvenAnalysis: { revenueThreshold: 0, unitBreakEven: 0, marginOfSafety: 0 },
                financialRatios: {
                    debtServiceCoverage: 0, returnOnAssets: 0, currentRatio: 0, operatingMargin: 0,
                    assetTurnover: 0, equityRatio: 0, quickRatio: 0, interestCoverage: 0, workingCapitalRatio: 0
                }
            },
            commercialAssessment: {
                customerAnalysis: {
                    top10Customers: [{ name: '', revenueShare: 0, servicingCost: 0 }],
                    customerConcentration: 0,
                    retentionRate: 0,
                    satisfactionScores: {},
                    relationshipStrength: ''
                },
                customerBaseDynamics: { growthTrends: '', pipelineAnalysis: '', leadGeneration: '' },
                salesPerformance: { pipelineEffectiveness: '', conversionRates: '', seasonalPatterns: '' },
                warrantyService: { obligationsAssessment: '', serviceQuality: '', returnExchangePolicies: '' },
                salesCompensation: { structureAnalysis: '', motivationSystems: '', financialIncentiveImpact: '' },
                distributionChannels: { representatives: [], distributors: [], agencies: [], franchiseArrangements: '' },
                salesStrategy: { marketingPlanEvaluation: '', pricingStrategy: '', promotionalEffectiveness: '' },
                salesDocumentation: { standardForms: '', literature: '', priceLists: '', catalogs: '', purchaseOrders: '' }
            },
            hrManagement: {
                organizationStructure: {
                    organizationalChart: '',
                    reportingRelationships: '',
                    roleClarity: '',
                    managementLevels: 0,
                    totalEmployees: 0,
                    keyPersonnel: [{ name: '', role: '', competencyScore: 0, experience: '' }]
                },
                hrPolicies: { employmentContracts: false, procedures: '', policyAdequacy: '' },
                laborRelations: { historicalStoppages: '', slowdowns: '', disputes: '', unionRelationships: '' },
                compensationAnalysis: { officerCompensation: 0, employeeCompensation: 0, nonCashBenefits: '', marketBenchmarking: '' },
                legalCompliance: { criminalProceedings: '', civilLitigationInvolvement: '', regulatoryIssues: '' },
                employmentLaw: { minimumWageCompliance: false, overtimeCompliance: false, immigrationCompliance: false, equityLegislationCompliance: false },
                retentionStrategies: { keyEmployeeAgreements: '', incentiveArrangements: '', successionPlanning: '' },
                severanceObligations: { layoffCosts: 0, terminationLiabilities: 0, restructuringImpact: '' },
                turnoverAnalysis: { employeeTurnoverRate: 0, consultantTurnoverRate: 0, retentionEffectiveness: '' },
                payrollCompliance: { uifPayments: false, statutoryDeductions: false, taxCompliance: false },
                managementCompetency: { successionPlanning: '' }
            },
            environmentalAssessment: {
                regulatoryCompliance: { environmentalAudits: '', records: '', complianceReports: '' },
                hazardousSubstances: { inventory: '', handlingProcedures: '', safetyProtocols: '' },
                permitsLicenses: { environmentalPermits: [], complianceStatus: '', renewalRequirements: '' },
                regulatoryCommunications: { eiaCorrespondence: '', agencyInteractions: '', complianceNotices: '' },
                environmentalLitigation: { claims: [], investigations: [], regulatoryProceedings: '' },
                contingentLiabilities: { environmentalCleanupObligations: 0, futureComplianceCosts: 0 },
                resourceManagement: { waterUsage: '', soilHealth: '', conservationPractices: '' },
                sustainabilityPractices: { renewableEnergy: false, wasteReduction: false, carbonFootprint: '' },
                climateAdaptation: { resiliencePlanning: '', riskMitigation: '', adaptationStrategies: '' }
            },
            legalCompliance: {
                corporateCompliance: { incorporationDocuments: '', validity: '', directorCompliance: false, governanceScore: 0, registrationStatus: '' },
                legalProceedings: { pendingThreatenedInvestigations: [], governmentalProceedings: [] },
                regulatoryCommunications: { governmentCorrespondence: '', municipalInteractions: '' },
                complianceCertification: { regulatoryStandardsCompliance: false, deficiencyAnalysis: '' },
                permitsLicenses: { requiredPermits: [], canceledTerminatedLicenses: [], exemptions: [] },
                taxCompliance: { incomeTax: false, vat: false, paye: false, municipalTaxes: false, clearanceCertificates: [] },
                taxLitigation: { pendingDisputes: [], auditFindings: [], settlementAgreements: [] },
                legalSettlements: { arbitrationMatters: [], disputeResolutions: [], ongoingLitigation: [] },
                insurancePortfolio: { coverageAdequacy: '', claimsHistory: '', riskExposureGaps: '' },
                contractCompliance: { materialAgreements: [], performanceObligations: '', breachRisks: '' }
            },
            agriculturalTechnical: {
                industryContext: { agriculturalSectorAnalysis: '', marketDynamics: '', regulatoryEnvironment: '' },
                landUtilization: { soilPotential: '', carryingCapacity: 0, sustainableCultivationAssessment: '', soilQualityScore: 0, landUseEfficiency: 0 },
                soilAnalysis: { physicalChemicalProperties: '', enhancementCapability: '', preparationNeeds: '' },
                waterResources: { availability: '', suitability: '', licensingStatus: '', irrigationEfficiency: 0 },
                livestockManagement: {
                    breedSelection: '',
                    breedingPrograms: { type: '', successRate: 0, geneticsOptimization: '' },
                    nutritionPrograms: { feedEfficiency: 0, integratedNutritionSystems: '', costOptimization: '' },
                    grazingManagement: { rotationalSystems: false, landUseOptimization: '', carryingCapacityPerHa: 0 },
                    animalHealth: { veterinaryPrograms: '', diseaseManagement: '', preventiveCare: '' },
                    animalHousing: { condition: '' }
                },
                productionEfficiency: {
                    yieldPerHectare: 0,
                    feedConversionRatio: 0,
                    mortalityRate: 0,
                    calvingRate: 0,
                    weaningWeight: 0,
                    averageDailyGain: 0
                },
                qualityStandards: { productQualityMetrics: '', certificationStatus: '', premiumPositioning: '' },
                technologyAdoption: { precisionAgriculture: false, automationLevel: '', modernFarmingTechniques: '', innovationScore: 0 },
                exportPotential: { internationalMarketAccess: false, certificationRequirements: '', competitiveAdvantage: '' }
            },
            riskAssessment: {
                productionRisks: {
                    weatherPatterns: { likelihood: 0, impact: 0, details: '' },
                    pestDiseaseManagement: { likelihood: 0, impact: 0, details: '' },
                    inputAvailabilityCost: { likelihood: 0, impact: 0, details: '' },
                    technologyRisk: { likelihood: 0, impact: 0, details: '' }
                },
                marketRisks: {
                    priceVolatility: { likelihood: 0, impact: 0, details: '' },
                    demandFluctuations: { likelihood: 0, impact: 0, details: '' },
                    competitionIntensity: { likelihood: 0, impact: 0, details: '' },
                    keyCustomerLoss: { likelihood: 0, impact: 0, details: '' },
                    exchangeRateExposure: { likelihood: 0, impact: 0, details: '' }
                },
                financialRisks: {
                    interestRateSensitivity: { likelihood: 0, impact: 0, details: '' },
                    creditAccess: { likelihood: 0, impact: 0, details: '' },
                    cashFlowStability: { likelihood: 0, impact: 0, details: '' },
                    costInflation: { likelihood: 0, impact: 0, details: '' },
                    debtBurdenManagement: { likelihood: 0, impact: 0, details: '' }
                },
                operationalRisks: {
                    laborAvailability: { likelihood: 0, impact: 0, details: '' },
                    equipmentReliability: { likelihood: 0, impact: 0, details: '' },
                    supplyChainDisruptions: { likelihood: 0, impact: 0, details: '' },
                    infrastructureRisks: { likelihood: 0, impact: 0, details: '' },
                    fireTheft: { likelihood: 0, impact: 0, details: '' }
                },
                environmentalRisks: {
                    climateChange: { likelihood: 0, impact: 0, details: '' },
                    waterScarcity: { likelihood: 0, impact: 0, details: '' },
                    pollutionRegulation: { likelihood: 0, impact: 0, details: '' }
                },
                regulatoryComplianceRisks: {
                    taxCompliance: { likelihood: 0, impact: 0, details: '' },
                    laborLaws: { likelihood: 0, impact: 0, details: '' },
                    environmentalLaws: { likelihood: 0, impact: 0, details: '' }
                },
                managementStrategicRisks: {
                    successionPlanning: { likelihood: 0, impact: 0, details: '' },
                    keyPersonDependency: { likelihood: 0, impact: 0, details: '' },
                    strategicDirection: { likelihood: 0, impact: 0, details: '' }
                },
                mitigationStrategies: '',
                contingencyPlanning: '',
                monitoringFramework: ''
            },
            scoring: {
                componentScores: {
                    financial: 0,
                    operational: 0,
                    market: 0,
                    management: 0,
                    compliance: 0,
                    agricultural: 0
                },
                weightedScore: 0,
                classification: ''
            },
            recommendations: {
                viabilityConclusion: '',
                swotAnalysis: {
                    strengths: [],
                    weaknesses: [],
                    opportunities: [],
                    threats: []
                },
                interventionPlan: []
            }
        };

        // ============================================
        // CORE APPLICATION LOGIC
        // ============================================

        async function loadFarm(farmId) {
            showLoading();
            currentFarmId = farmId;
            saveLastUsedFarmId(farmId);

            let data = await loadFarmDataIndexedDB(farmId);

            if (data) {
                farmAssessmentData = data;
                farmAssessmentData.farmProfile.basicInfo.farmId = farmId;
                showStatus(`Loaded data for farm: ${farmAssessmentData.farmProfile.basicInfo.farmName || 'Unnamed Farm'}`);
            } else {
                farmAssessmentData = JSON.parse(JSON.stringify(defaultFarmAssessmentData));
                farmAssessmentData.farmProfile.basicInfo.farmId = farmId;
                showStatus('Initialized new farm data. Please name this farm.');
            }

            updateFarmSelector();
            const activeModuleElement = document.querySelector('.sidebar .nav-link.active') || document.querySelector('.offcanvas-body .nav-link.active');
            const activeModuleName = activeModuleElement ? activeModuleElement.dataset.module : 'executive-summary';
            renderModule(activeModuleName);
            hideLoading();
        }

        async function saveCurrentFarmData() {
            if (!currentFarmId) {
                showStatus('No farm selected to save.', true);
                return;
            }
            await saveFarmDataIndexedDB(currentFarmId, farmAssessmentData);
            showStatus('Farm data saved successfully.');
        }

        async function createNewFarm() {
            const newId = generateUniqueId();
            const newFarmData = JSON.parse(JSON.stringify(defaultFarmAssessmentData));
            newFarmData.farmProfile.basicInfo.farmId = newId;

            allFarmIds.push(newId);
            await saveFarmDataIndexedDB(newId, newFarmData);
            await loadFarm(newId);
            showStatus(`Created new farm. Please name it.`);
        }

        async function deleteCurrentFarm() {
            if (!currentFarmId) {
                showStatus('No farm selected to delete.', true);
                return;
            }

            const confirmDelete = confirm(`Are you sure you want to delete "${farmAssessmentData.farmProfile.basicInfo.farmName || 'this unnamed farm'}"? This action cannot be undone.`);
            if (!confirmDelete) {
                return;
            }

            await deleteFarmDataIndexedDB(currentFarmId);
            allFarmIds = allFarmIds.filter(id => id !== currentFarmId);
            currentFarmId = null;
            farmAssessmentData = {};

            if (allFarmIds.length > 0) {
                await loadFarm(allFarmIds[0]);
            } else {
                await createNewFarm();
            }
            showStatus('Farm deleted successfully.');
        }

        function updateFarmSelector() {
            const farmSelector = document.getElementById('farmSelector');
            farmSelector.innerHTML = '';
            if (allFarmIds.length === 0) {
                farmSelector.innerHTML = '<option value="">No Farms</option>';
                farmSelector.disabled = true;
                document.getElementById('deleteFarmBtn').disabled = true;
            } else {
                farmSelector.disabled = false;
                document.getElementById('deleteFarmBtn').disabled = false;
                allFarmIds.forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    let displayName = `Farm ${allFarmIds.indexOf(id) + 1}`;
                    if (currentFarmId === id && farmAssessmentData.farmProfile.basicInfo.farmName) {
                        displayName = farmAssessmentData.farmProfile.basicInfo.farmName;
                    }
                    option.textContent = displayName;
                    farmSelector.appendChild(option);
                });
                farmSelector.value = currentFarmId;
            }
        }

        // ============================================
        // MODULE RENDERING
        // ============================================

        function renderModule(moduleName) {
            const moduleContent = document.getElementById('moduleContent');
            let html = '';

            switch (moduleName) {
                case 'executive-summary':
                    html = renderExecutiveSummaryModule();
                    break;
                case 'business-description':
                    html = renderBusinessDescriptionModule();
                    break;
                case 'financial-assessment':
                    html = renderFinancialAssessmentModule();
                    break;
                case 'commercial-marketing':
                    html = renderCommercialMarketingModule();
                    break;
                case 'hr-management':
                    html = renderHRManagementModule();
                    break;
                case 'environmental-assessment':
                    html = renderEnvironmentalAssessmentModule();
                    break;
                case 'legal-regulatory':
                    html = renderLegalRegulatoryModule();
                    break;
                case 'agricultural-technical':
                    html = renderAgriculturalTechnicalModule();
                    break;
                case 'risk-analysis':
                    html = renderRiskAnalysisModule();
                    break;
                case 'scoring-classification':
                    html = renderScoringClassificationModule();
                    break;
                case 'viability-conclusion':
                    html = renderViabilityConclusionModule();
                    break;
                case 'reporting-system':
                    html = renderReportingSystemModule();
                    break;
                default:
                    html = '<div class="alert alert-warning">Module not found.</div>';
            }

            moduleContent.innerHTML = html;
            attachEventListeners();
        } 

        function renderExecutiveSummaryModule() {
            const data = farmAssessmentData.farmProfile.basicInfo;
            return `
                <div class="card">
                    <div class="card-header">Executive Summary</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="farmName" class="form-label">Farm Name</label>
                            <input type="text" class="form-control" id="farmName" name="farmProfile.basicInfo.farmName" value="${data.farmName || ''}">
                        </div>
                        <div class="mb-3">
                            <label for="totalHectares" class="form-label">Total Hectares</label>
                            <input type="number" class="form-control" id="totalHectares" name="farmProfile.basicInfo.totalHectares" value="${data.totalHectares || 0}">
                        </div>
                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="farmProfile.basicInfo.location" value="${data.location || ''}">
                        </div>
                        <div class="mb-3">
                            <label for="overallViability" class="form-label">Overall Viability Assessment</label>
                            <input type="text" class="form-control" id="overallViability" name="recommendations.viabilityConclusion" value="${farmAssessmentData.recommendations.viabilityConclusion || ''}" readonly>
                        </div>
                        <button class="btn btn-primary" id="calculateOverallScoreBtn">Calculate Overall Score</button>
                    </div>
                </div>
            `;
        }

        function renderBusinessDescriptionModule() {
            return `
                <div class="card">
                    <div class="card-header">Business Description</div>
                    <div class="card-body">
                        <p>Enter details about your farm's business structure, infrastructure, and core activities.</p>
                        <div class="mb-3">
                            <label for="legalStructure" class="form-label">Legal Structure</label>
                            <select class="form-select" id="legalStructure" name="farmProfile.legalStructure">
                                <option value="">Select...</option>
                                <option value="Sole Proprietor" ${farmAssessmentData.farmProfile.legalStructure === 'Sole Proprietor' ? 'selected' : ''}>Sole Proprietor</option>
                                <option value="Partnership" ${farmAssessmentData.farmProfile.legalStructure === 'Partnership' ? 'selected' : ''}>Partnership</option>
                                <option value="CC" ${farmAssessmentData.farmProfile.legalStructure === 'CC' ? 'selected' : ''}>Close Corporation</option>
                                <option value="PTY" ${farmAssessmentData.farmProfile.legalStructure === 'PTY' ? 'selected' : ''}>Pty Ltd</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="saveBtn">Save</button>
                    </div>
                </div>
            `;
        }

        function renderFinancialAssessmentModule() {
            const histData = farmAssessmentData.financialAssessment.historicalData;
            return `
                <div class="card">
                    <div class="card-header">Financial Assessment</div>
                    <div class="card-body">
                        <h5>Year 3 (Most Recent) Financial Data</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="y3revenue" class="form-label">Revenue</label>
                                <input type="number" class="form-control" id="y3revenue" name="financialAssessment.historicalData.year3.revenue" value="${histData.year3.revenue || 0}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="y3operatingCosts" class="form-label">Operating Costs</label>
                                <input type="number" class="form-control" id="y3operatingCosts" name="financialAssessment.historicalData.year3.operatingCosts" value="${histData.year3.operatingCosts || 0}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="y3totalAssets" class="form-label">Total Assets</label>
                                <input type="number" class="form-control" id="y3totalAssets" name="financialAssessment.historicalData.year3.totalAssets" value="${histData.year3.totalAssets || 0}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="y3totalLiabilities" class="form-label">Total Liabilities</label>
                                <input type="number" class="form-control" id="y3totalLiabilities" name="financialAssessment.historicalData.year3.totalLiabilities" value="${histData.year3.totalLiabilities || 0}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="y3netIncome" class="form-label">Net Income</label>
                                <input type="number" class="form-control" id="y3netIncome" name="financialAssessment.historicalData.year3.netIncome" value="${histData.year3.netIncome || 0}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="y3currentAssets" class="form-label">Current Assets</label>
                                <input type="number" class="form-control" id="y3currentAssets" name="financialAssessment.historicalData.year3.currentAssets" value="${histData.year3.currentAssets || 0}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="y3currentLiabilities" class="form-label">Current Liabilities</label>
                                <input type="number" class="form-control" id="y3currentLiabilities" name="financialAssessment.historicalData.year3.currentLiabilities" value="${histData.year3.currentLiabilities || 0}">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="saveBtn">Save</button>
                        <button class="btn btn-info ms-2" id="calcRatiosBtn">Calculate Ratios (Update UI)</button>
                    </div>
                </div>
            `;
        }

        function renderCommercialMarketingModule() {
            const ca = farmAssessmentData.commercialAssessment;
            return `
                <div class="card">
                    <div class="card-header">Commercial & Marketing Assessment</div>
                    <div class="card-body">
                        <h5>Customer Analysis</h5>
                        <div class="mb-3">
                            <label for="customerConcentration" class="form-label">Customer Concentration (%)</label>
                            <input type="number" class="form-control" id="customerConcentration" name="commercialAssessment.customerAnalysis.customerConcentration" value="${ca.customerAnalysis.customerConcentration || 0}" min="0" max="100">
                        </div>
                        <div class="mb-3">
                            <label for="retentionRate" class="form-label">Customer Retention Rate (%)</label>
                            <input type="number" class="form-control" id="retentionRate" name="commercialAssessment.customerAnalysis.retentionRate" value="${ca.customerAnalysis.retentionRate || 0}" min="0" max="100">
                        </div>
                        <button class="btn btn-primary" id="saveBtn">Save</button>
                    </div>
                </div>
            `;
        }

        function renderHRManagementModule() {
            const hr = farmAssessmentData.hrManagement;
            return `
                <div class="card">
                    <div class="card-header">HR Management</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="totalEmployees" class="form-label">Total Employees</label>
                            <input type="number" class="form-control" id="totalEmployees" name="hrManagement.organizationStructure.totalEmployees" value="${hr.organizationStructure.totalEmployees || 0}">
                        </div>
                        <button class="btn btn-primary" id="saveBtn">Save</button>
                    </div>
                </div>
            `;
        }

        function renderEnvironmentalAssessmentModule() {
            return `
                <div class="card">
                    <div class="card-header">Environmental Assessment</div>
                    <div class="card-body">
                        <p>Assess environmental compliance and sustainability practices.</p>
                        <button class="btn btn-primary" id="saveBtn">Save</button>
                    </div>
                </div>
            `;
        }

        function renderLegalRegulatoryModule() {
            return `
                <div class="card">
                    <div class="card-header">Legal & Regulatory Compliance</div>
                    <div class="card-body">
                        <p>Review legal compliance and regulatory status.</p>
                        <button class="btn btn-primary" id="saveBtn">Save</button>
                    </div>
                </div>
            `;
        }

        function renderAgriculturalTechnicalModule() {
            const ag = farmAssessmentData.agriculturalTechnical;
            return `
                <div class="card">
                    <div class="card-header">Agricultural & Technical Assessment</div>
                    <div class="card-body">
                        <h5>Production Efficiency</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="calvingRate" class="form-label">Calving Rate (%)</label>
                                <input type="number" class="form-control" id="calvingRate" name="agriculturalTechnical.productionEfficiency.calvingRate" value="${ag.productionEfficiency.calvingRate || 0}" min="0" max="100">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="mortalityRate" class="form-label">Mortality Rate (%)</label>
                                <input type="number" class="form-control" id="mortalityRate" name="agriculturalTechnical.productionEfficiency.mortalityRate" value="${ag.productionEfficiency.mortalityRate || 0}" min="0" max="100">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="saveBtn">Save</button>
                    </div>
                </div>
            `;
        }

        function renderRiskAnalysisModule() {
            return `
                <div class="card">
                    <div class="card-header">Risk Analysis</div>
                    <div class="card-body">
                        <p>Assess production, market, financial, operational, and environmental risks.</p>
                        <button class="btn btn-primary" id="saveBtn">Save</button>
                    </div>
                </div>
            `;
        }

        function renderScoringClassificationModule() {
            const scores = farmAssessmentData.scoring.componentScores;
            const weightedScore = farmAssessmentData.scoring.weightedScore;
            const classification = farmAssessmentData.scoring.classification;

            return `
                <div class="card">
                    <div class="card-header">Scoring & Classification</div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-4" id="calculateOverallScoreBtn">Calculate Overall Score</button>
                        <h5>Component Scores</h5>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Financial Health (25%):</span>
                                <span>${scores.financial.toFixed(2)}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Operational Excellence (20%):</span>
                                <span>${scores.operational.toFixed(2)}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Market Position (20%):</span>
                                <span>${scores.market.toFixed(2)}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Management Quality (15%):</span>
                                <span>${scores.management.toFixed(2)}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Compliance & Risk (10%):</span>
                                <span>${scores.compliance.toFixed(2)}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Agricultural Excellence (10%):</span>
                                <span>${scores.agricultural.toFixed(2)}</span>
                            </li>
                        </ul>
                        <div class="mt-4">
                            <h5>Overall Assessment</h5>
                            <p><strong>Weighted Score:</strong> <span class="badge bg-info">${weightedScore.toFixed(2)}</span></p>
                            <p><strong>Classification:</strong> <span class="badge bg-primary">${classification || 'Not Calculated'}</span></p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderViabilityConclusionModule() {
            return `
                <div class="card">
                    <div class="card-header">Viability Conclusion & Recommendations</div>
                    <div class="card-body">
                        <p>Overall viability assessment and strategic recommendations.</p>
                        <button class="btn btn-primary" id="saveBtn">Save</button>
                    </div>
                </div>
            `;
        }

        function renderReportingSystemModule() {
            return `
                <div class="card">
                    <div class="card-header">Comprehensive Report Generation</div>
                    <div class="card-body">
                        <p>Generate a comprehensive farm viability assessment report.</p>
                        <button class="btn btn-primary" id="generateReportBtn">Generate Comprehensive Report</button>
                        <button class="btn btn-secondary ms-2" id="downloadReportBtn" style="display: none;">Download Report (PDF)</button>
                        <div id="reportPreview" style="margin-top: 20px; display: none;"></div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // ENHANCED REPORT GENERATION
        // ============================================

        function generateComprehensiveReport() {
            const data = farmAssessmentData;
            const farmName = data.farmProfile.basicInfo.farmName || 'Unnamed Farm';
            const totalHectares = data.farmProfile.basicInfo.totalHectares || 0;
            const location = data.farmProfile.basicInfo.location || 'Not Specified';
            const reportDate = new Date().toLocaleDateString('en-ZA', { year: 'numeric', month: 'long', day: 'numeric' });

            // --- 1. CALCULATE KEY METRICS AND RATIOS ---
            const year3 = data.financialAssessment.historicalData.year3;
            const revenue = year3.revenue || 0;
            const operatingCosts = year3.operatingCosts || 0;
            const netIncome = year3.netIncome || 0;
            const ebit = year3.ebit || 0;
            const interestExpense = year3.interestExpense || 0;
            const totalAssets = year3.totalAssets || 0;
            const totalLiabilities = year3.totalLiabilities || 0;
            const totalEquity = totalAssets - totalLiabilities;
            const currentAssets = year3.currentAssets || 0;
            const currentLiabilities = year3.currentLiabilities || 0;

            // Financial Ratios
            const grossMargin = revenue > 0 ? ((revenue - operatingCosts) / revenue * 100) : 0;
            const netMargin = revenue > 0 ? (netIncome / revenue * 100) : 0;
            const currentRatio = currentLiabilities > 0 ? (currentAssets / currentLiabilities) : 0;
            const debtRatio = totalAssets > 0 ? (totalLiabilities / totalAssets * 100) : 0;
            const equityRatio = totalAssets > 0 ? (totalEquity / totalAssets * 100) : 0;
            const roa = totalAssets > 0 ? (netIncome / totalAssets * 100) : 0;
            const roe = totalEquity > 0 ? (netIncome / totalEquity * 100) : 0;
            const interestCoverage = interestExpense > 0 ? (ebit / interestExpense) : Infinity;

            // Production Metrics
            const calvingRate = data.agriculturalTechnical.productionEfficiency.calvingRate || 0;
            const mortalityRate = data.agriculturalTechnical.productionEfficiency.mortalityRate || 0;
            const breedSelection = data.agriculturalTechnical.livestockManagement.breedSelection || 'Not Specified';

            // Commercial Metrics
            const customerConcentration = data.commercialAssessment.customerAnalysis.customerConcentration || 0;
            const retentionRate = data.commercialAssessment.customerAnalysis.retentionRate || 0;

            // SWOT
            const swot = data.recommendations.swotAnalysis;
            const strengths = swot.strengths || [];
            const weaknesses = swot.weaknesses || [];
            const opportunities = swot.opportunities || [];
            const threats = swot.threats || [];

            // Scoring
            const weightedScore = data.scoring.weightedScore.toFixed(2);
            const classification = data.scoring.classification || 'Not Assessed';

            // --- 2. DEDUCTIVE NARRATIVE GENERATION ---

            // --- Financial Narrative ---
            let financialNarrative = '';
            let financialRating = 'AT RISK';
            if (currentRatio > 2 && debtRatio < 30) {
                financialNarrative = `The farm exhibits a **highly robust financial position**. Liquidity is exceptionally strong with a Current Ratio of **${currentRatio.toFixed(2)}**, indicating a strong ability to meet short-term obligations. Solvency is also excellent, with a minimal Debt Ratio of **${debtRatio.toFixed(2)}%**, suggesting a low reliance on external financing and an extremely low insolvency risk. Profitability, as demonstrated by a Net Profit Margin of **${netMargin.toFixed(2)}%**, is solid.`;
                financialRating = 'HIGHLY VIABLE';
            } else if (currentRatio > 1 && debtRatio < 50) {
                financialNarrative = `The financial position is **viable with conditions**. The Current Ratio of **${currentRatio.toFixed(2)}** suggests adequate liquidity. The Debt Ratio of **${debtRatio.toFixed(2)}%** is manageable, but monitoring of debt servicing capacity is recommended. Profitability is acceptable, but efficiency in asset utilization (ROA: ${roa.toFixed(2)}%) presents an opportunity for improvement.`;
                financialRating = 'VIABLE WITH CONDITIONS';
            } else {
                financialNarrative = `The financial position is **at risk**. A Current Ratio of **${currentRatio.toFixed(2)}** indicates potential liquidity stress. The Debt Ratio of **${debtRatio.toFixed(2)}%** suggests a high reliance on debt, increasing solvency risk. Immediate attention to working capital management and debt restructuring is critical.`;
            }

            // --- Market Narrative ---
            let marketNarrative = '';
            let marketRating = 'AT RISK';
            if (customerConcentration < 20) {
                marketNarrative = `Market viability is **strong**. The customer base is well-diversified, with a concentration risk of only **${customerConcentration}%**. This stability minimizes revenue volatility and provides a strong foundation for market expansion.`;
                marketRating = 'HIGHLY VIABLE';
            } else if (customerConcentration < 50) {
                marketNarrative = `Market viability is **moderate**. A customer concentration of **${customerConcentration}%** creates a moderate vulnerability. While the farm has established market access, the loss of a key customer could significantly impact revenue. Strategic diversification is recommended.`;
                marketRating = 'VIABLE WITH CONDITIONS';
            } else {
                marketNarrative = `Market viability is **at risk**. A severe customer concentration of **${customerConcentration}%** creates a critical vulnerability. The farm is highly exposed to the risk of losing a significant portion of its revenue. Immediate development of a formal marketing strategy and off-take agreements is essential.`;
            }

            // --- Production Narrative ---
            let productionNarrative = '';
            let productionRating = 'AT RISK';
            if (calvingRate >= 90 && mortalityRate < 5) {
                productionNarrative = `Technical performance is **exceptional**. The Calving Rate of **${calvingRate}%** substantially exceeds industry standards, demonstrating superior animal husbandry and strong production management. The low Mortality Rate of **${mortalityRate}%** confirms excellent herd health.`;
                productionRating = 'HIGHLY VIABLE';
            } else if (calvingRate >= 75 && mortalityRate < 10) {
                productionNarrative = `Technical performance is **solid**. The Calving Rate of **${calvingRate}%** is within acceptable industry benchmarks. Focus should be placed on optimizing feed conversion and addressing any aging infrastructure issues that could compromise future efficiency.`;
                productionRating = 'VIABLE';
            } else {
                productionNarrative = `Technical performance is **at risk**. The Calving Rate of **${calvingRate}%** and Mortality Rate of **${mortalityRate}%** suggest underlying issues in herd health or breeding programs. Immediate veterinary and technical review is required to restore production efficiency.`;
            }

            // --- Management Narrative (Simplified) ---
            let managementNarrative = 'Management demonstrates strong technical competence (e.g., in production) but is often deficient in formal business management capabilities (finance, compliance, strategic planning). Succession planning is a key strength, but professional advisory support is urgently required.';
            let managementRating = 'VIABLE WITH SUPPORT';

            // --- Compliance Narrative (Simplified) ---
            let complianceNarrative = 'Compliance is a significant area of concern. While basic corporate compliance may be met, non-compliance in critical areas such as tax (if indicated) or environmental permits creates severe regulatory and financial risk. Full compliance restoration is a critical condition for viability.';
            let complianceRating = 'AT RISK';

            // --- 3. BUILD REPORT HTML ---

            let reportHtml = `
                <div style="font-family: 'Times New Roman', serif; line-height: 1.6; color: #000; max-width: 900px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px;">
                        <h1 style="font-size: 24px; margin: 0 0 10px 0;">FARM VIABILITY ASSESSMENT REPORT</h1>
                        <h2 style="font-size: 18px; color: #666; margin: 0 0 20px 0;">FOR ${farmName.toUpperCase()}</h2>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px;">
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; width: 30%;">Farm Name</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${farmName}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Location</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${location}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Total Hectares</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${totalHectares.toLocaleString()} ha</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Report Date</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${reportDate}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Overall Viability</td>
                                <td style="border: 1px solid #ddd; padding: 8px;"><strong>${classification}</strong> (Weighted Score: ${weightedScore})</td>
                            </tr>
                        </table>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h2 style="font-size: 16px; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">I. EXECUTIVE SUMMARY</h2>
                        <p style="margin-bottom: 15px;">
                            The assessment concludes that the farm's overall viability is **${classification}** (Weighted Score: ${weightedScore}). 
                            The operation demonstrates core strengths in **${productionRating}** technical performance and **${financialRating}** financial stability. 
                            However, viability is contingent upon addressing critical conditions, particularly the **${marketRating}** market concentration risk and the **${complianceRating}** compliance issues.
                        </p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h2 style="font-size: 16px; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">II. FINANCIAL VIABILITY</h2>
                        
                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0;">Key Financial Metrics (Year 3):</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 12px;">
                            <tr style="background-color: #f5f5f5;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Metric</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Value (ZAR)</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Ratio</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Value (%)</th>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">Revenue</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${revenue.toLocaleString()}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">Gross Margin</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${grossMargin.toFixed(2)}%</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">Net Income</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${netIncome.toLocaleString()}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">Net Profit Margin</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${netMargin.toFixed(2)}%</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">Total Assets</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${totalAssets.toLocaleString()}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">Current Ratio</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${currentRatio.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">Total Liabilities</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${totalLiabilities.toLocaleString()}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">Debt Ratio</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${debtRatio.toFixed(2)}%</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">Total Equity</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${totalEquity.toLocaleString()}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">Return on Equity (ROE)</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${roe.toFixed(2)}%</td>
                            </tr>
                        </table>

                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0;">Narrative Conclusion:</h3>
                        <p style="margin-bottom: 10px; padding: 10px; background-color: #e8f4f8; border-left: 4px solid #007bff;">
                            ${financialNarrative}
                        </p>
                        <p style="margin-bottom: 10px;">
                            **Financial Viability Rating:** **${financialRating}**
                        </p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h2 style="font-size: 16px; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">III. MARKET VIABILITY</h2>
                        
                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0;">Key Market Metrics:</h3>
                        <ul style="margin-bottom: 15px; padding-left: 20px; font-size: 12px;">
                            <li>Customer Concentration: **${customerConcentration}%**</li>
                            <li>Customer Retention Rate: **${retentionRate}%**</li>
                        </ul>

                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0;">Narrative Conclusion:</h3>
                        <p style="margin-bottom: 10px; padding: 10px; background-color: #e8f4f8; border-left: 4px solid #007bff;">
                            ${marketNarrative}
                        </p>
                        <p style="margin-bottom: 10px;">
                            **Market Viability Rating:** **${marketRating}**
                        </p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h2 style="font-size: 16px; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">IV. PRODUCTION & TECHNICAL VIABILITY</h2>
                        
                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0;">Key Production Metrics:</h3>
                        <ul style="margin-bottom: 15px; padding-left: 20px; font-size: 12px;">
                            <li>Calving Rate: **${calvingRate}%** (Industry Standard: 85-90%)</li>
                            <li>Mortality Rate: **${mortalityRate}%**</li>
                            <li>Primary Breed Selection: **${breedSelection}**</li>
                        </ul>

                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0;">Narrative Conclusion:</h3>
                        <p style="margin-bottom: 10px; padding: 10px; background-color: #e8f4f8; border-left: 4px solid #007bff;">
                            ${productionNarrative}
                        </p>
                        <p style="margin-bottom: 10px;">
                            **Production Viability Rating:** **${productionRating}**
                        </p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h2 style="font-size: 16px; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">V. MANAGEMENT & COMPLIANCE VIABILITY</h2>
                        
                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0;">Management Narrative:</h3>
                        <p style="margin-bottom: 10px; padding: 10px; background-color: #e8f4f8; border-left: 4px solid #007bff;">
                            ${managementNarrative}
                        </p>
                        <p style="margin-bottom: 10px;">
                            **Management Viability Rating:** **${managementRating}**
                        </p>

                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0;">Compliance Narrative:</h3>
                        <p style="margin-bottom: 10px; padding: 10px; background-color: #e8f4f8; border-left: 4px solid #007bff;">
                            ${complianceNarrative}
                        </p>
                        <p style="margin-bottom: 10px;">
                            **Compliance Viability Rating:** **${complianceRating}**
                        </p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h2 style="font-size: 16px; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">VI. SWOT ANALYSIS</h2>
                        
                        ${strengths.length > 0 ? `
                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0; color: #28a745;">Strengths:</h3>
                        <ul style="margin-bottom: 15px; padding-left: 20px; font-size: 12px;">
                            ${strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                        ` : '<p style="font-size: 12px;">No strengths identified.</p>'}

                        ${weaknesses.length > 0 ? `
                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0; color: #dc3545;">Weaknesses:</h3>
                        <ul style="margin-bottom: 15px; padding-left: 20px; font-size: 12px;">
                            ${weaknesses.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                        ` : '<p style="font-size: 12px;">No weaknesses identified.</p>'}

                        ${opportunities.length > 0 ? `
                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0; color: #17a2b8;">Opportunities:</h3>
                        <ul style="margin-bottom: 15px; padding-left: 20px; font-size: 12px;">
                            ${opportunities.map(o => `<li>${o}</li>`).join('')}
                        </ul>
                        ` : '<p style="font-size: 12px;">No opportunities identified.</p>'}

                        ${threats.length > 0 ? `
                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0; color: #ffc107;">Threats:</h3>
                        <ul style="margin-bottom: 15px; padding-left: 20px; font-size: 12px;">
                            ${threats.map(t => `<li>${t}</li>`).join('')}
                        </ul>
                        ` : '<p style="font-size: 12px;">No threats identified.</p>'}
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h2 style="font-size: 16px; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">VII. OVERALL VIABILITY CONCLUSION</h2>
                        
                        <div style="padding: 15px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; margin-bottom: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #155724;">RECOMMENDATION: ${classification.toUpperCase()}</h3>
                            <p style="margin: 0; color: #155724; font-size: 12px;">
                                The farm is assessed as **${classification}** with a composite weighted score of **${weightedScore}**. 
                                This rating is a result of the balance between the farm's **${financialRating}** financial health and **${productionRating}** technical capacity, 
                                offset by the significant risks posed by **${marketRating}** market concentration and **${complianceRating}** compliance status.
                            </p>
                        </div>

                        <h3 style="font-size: 13px; font-weight: bold; margin: 15px 0 10px 0;">Viability Assessment by Dimension:</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 12px;">
                            <tr style="background-color: #f5f5f5;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Dimension</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Rating</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Key Comment</th>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">Financial Viability</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${financialRating}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">Strong liquidity and solvency, solid profitability.</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">Market Viability</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${marketRating}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">Critical customer concentration risk.</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">Production/Technical</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${productionRating}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">Exceptional calving rate, but infrastructure may be a concern.</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">Management</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${managementRating}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">Strong technical skills, weak business administration.</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">Compliance</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${complianceRating}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">Compliance gaps create regulatory risk.</td>
                            </tr>
                        </table>
                    </div>

                    <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 11px; color: #999;">
                        <p>This report was generated on ${reportDate} using the Farm Viability Assessment System.</p>
                        <p> ${new Date().getFullYear()} Farm Viability Assessment Tool. All rights reserved.</p>
                    </div>
                </div>
            `;

            return reportHtml;
        }

        // ============================================
        // EVENT LISTENERS AND INITIALIZATION
        // ============================================

        function attachEventListeners() {
            // Save button
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    collectFormData();
                    await saveCurrentFarmData();
                    updateAllModuleProgress();
                });
            }

            // Calculate score button
            const calcScoreBtn = document.getElementById('calculateOverallScoreBtn');
            if (calcScoreBtn) {
                calcScoreBtn.addEventListener('click', calculateOverallScore);
            }

            // Calculate Ratios button (Financial Module)
            const calcRatiosBtn = document.getElementById('calcRatiosBtn');
            if (calcRatiosBtn) {
                calcRatiosBtn.addEventListener('click', () => {
                    collectFormData(); // Ensure inputs are grabbed first
                    calculateFinancialRatios();
                });
            }

            // Generate report button
            const genReportBtn = document.getElementById('generateReportBtn');
            if (genReportBtn) {
                genReportBtn.addEventListener('click', () => {
                    const reportHtml = generateComprehensiveReport();
                    const preview = document.getElementById('reportPreview');
                    preview.innerHTML = reportHtml;
                    preview.style.display = 'block';
                    document.getElementById('downloadReportBtn').style.display = 'inline-block';
                });
            }

            // Download report button
            const dlReportBtn = document.getElementById('downloadReportBtn');
            if (dlReportBtn) {
                dlReportBtn.addEventListener('click', () => {
                    const reportHtml = generateComprehensiveReport();
                    const printWindow = window.open('', '', 'width=900,height=600');
                    printWindow.document.write(reportHtml);
                    printWindow.document.close();
                    printWindow.print();
                });
            }
        }

        function collectFormData() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                const name = input.name;
                if (!name) return;

                const keys = name.split('.');
                let obj = farmAssessmentData;

                for (let i = 0; i < keys.length - 1; i++) {
                    if (!obj[keys[i]]) {
                        obj[keys[i]] = {};
                    }
                    obj = obj[keys[i]];
                }

                const lastKey = keys[keys.length - 1];
                if (input.type === 'checkbox') {
                    obj[lastKey] = input.checked;
                } else if (input.type === 'number') {
                    obj[lastKey] = parseFloat(input.value) || 0;
                } else {
                    obj[lastKey] = input.value;
                }
            });
        }

        function calculateFinancialRatios() {
            const histData = farmAssessmentData.financialAssessment.historicalData;
            const y1 = histData.year1;
            const y2 = histData.year2;
            const y3 = histData.year3;

            // Simple average of 3 years
            const avgRevenue = ((y1.revenue || 0) + (y2.revenue || 0) + (y3.revenue || 0)) / 3;
            const avgOperatingCosts = ((y1.operatingCosts || 0) + (y2.operatingCosts || 0) + (y3.operatingCosts || 0)) / 3;
            const avgTotalAssets = ((y1.totalAssets || 0) + (y2.totalAssets || 0) + (y3.totalAssets || 0)) / 3;
            const avgTotalLiabilities = ((y1.totalLiabilities || 0) + (y2.totalLiabilities || 0) + (y3.totalLiabilities || 0)) / 3;
            const avgNetIncome = ((y1.netIncome || 0) + (y2.netIncome || 0) + (y3.netIncome || 0)) / 3;
            const avgEBIT = ((y1.ebit || 0) + (y2.ebit || 0) + (y3.ebit || 0)) / 3;
            const avgInterestExpense = ((y1.interestExpense || 0) + (y2.interestExpense || 0) + (y3.interestExpense || 0)) / 3;
            const avgCurrentAssets = ((y1.currentAssets || 0) + (y2.currentAssets || 0) + (y3.currentAssets || 0)) / 3;
            const avgCurrentLiabilities = ((y1.currentLiabilities || 0) + (y2.currentLiabilities || 0) + (y3.currentLiabilities || 0)) / 3;
            const avgInventory = ((y1.inventory || 0) + (y2.inventory || 0) + (y3.inventory || 0)) / 3;
            const avgTotalEquity = avgTotalAssets - avgTotalLiabilities;

            const netOperatingIncome = avgRevenue - avgOperatingCosts;
            const totalDebtService = avgInterestExpense + (avgTotalLiabilities * 0.1); 

            // Calculations
            farmAssessmentData.financialAssessment.financialRatios.debtServiceCoverage = totalDebtService > 0 ? (netOperatingIncome / totalDebtService) : 0;
            farmAssessmentData.financialAssessment.financialRatios.returnOnAssets = avgTotalAssets > 0 ? (avgNetIncome / avgTotalAssets) : 0;
            farmAssessmentData.financialAssessment.financialRatios.currentRatio = avgCurrentLiabilities > 0 ? (avgCurrentAssets / avgCurrentLiabilities) : 0;
            farmAssessmentData.financialAssessment.financialRatios.operatingMargin = avgRevenue > 0 ? (netOperatingIncome / avgRevenue) : 0;
            farmAssessmentData.financialAssessment.financialRatios.assetTurnover = avgTotalAssets > 0 ? (avgRevenue / avgTotalAssets) : 0;
            farmAssessmentData.financialAssessment.financialRatios.equityRatio = avgTotalAssets > 0 ? (avgTotalEquity / avgTotalAssets) : 0;
            farmAssessmentData.financialAssessment.financialRatios.quickRatio = avgCurrentLiabilities > 0 ? ((avgCurrentAssets - avgInventory) / avgCurrentLiabilities) : 0;
            farmAssessmentData.financialAssessment.financialRatios.interestCoverage = avgInterestExpense > 0 ? (avgEBIT / avgInterestExpense) : 0;
            farmAssessmentData.financialAssessment.financialRatios.workingCapitalRatio = avgTotalAssets > 0 ? ((avgCurrentAssets - avgCurrentLiabilities) / avgTotalAssets) : 0;

            saveCurrentFarmData();
            showStatus('Financial ratios calculated.');
        }

        function calculateOverallScore() {
            // Updated to use the robust logic from Version 39
            const scores = farmAssessmentData.scoring.componentScores;
            
            // --- Financial Health (25%) ---
            let financialScore = 0;
            const fr = farmAssessmentData.financialAssessment.financialRatios;
            financialScore += (fr.returnOnAssets * 100 > 0 ? Math.min(fr.returnOnAssets * 100 * 2, 100) : 0) * 0.25; 
            financialScore += (fr.currentRatio > 1.5 ? Math.min(fr.currentRatio * 20, 100) : 0) * 0.25; 
            financialScore += (fr.debtServiceCoverage > 1.25 ? Math.min(fr.debtServiceCoverage * 40, 100) : 0) * 0.25; 
            financialScore += (fr.operatingMargin * 100 > 10 ? Math.min(fr.operatingMargin * 100 * 2, 100) : 0) * 0.25; 
            scores.financial = financialScore;

            // --- Operational Excellence (20%) ---
            let operationalScore = 0;
            const infra = farmAssessmentData.farmProfile.infrastructure;
            const businessDesc = farmAssessmentData.farmProfile;
            const maxOperationalScore = 600;

            operationalScore += OPTIONS.landTenure[businessDesc.basicInfo.landTenure] || 0;
            operationalScore += OPTIONS.legalStructure[businessDesc.legalStructure] || 0;
            operationalScore += OPTIONS.condition[getNestedValue(infra, 'buildings.0.condition')] || 0;
            operationalScore += OPTIONS.condition[getNestedValue(infra, 'equipment.0.condition')] || 0;
            operationalScore += OPTIONS.identificationSystem[businessDesc.herdDetails.identificationSystem] || 0;
            operationalScore += OPTIONS.herdHealthStatus[businessDesc.herdDetails.herdHealthStatus] || 0;
            scores.operational = (operationalScore / maxOperationalScore) * 100;

            // --- Market Position (20%) ---
            let marketScore = 0;
            const commercial = farmAssessmentData.commercialAssessment;
            const maxMarketScore = 500;

            marketScore += (commercial.customerAnalysis.customerConcentration < 50 ? 100 : 0);
            marketScore += (commercial.customerAnalysis.retentionRate > 70 ? 100 : 0);
            marketScore += OPTIONS.relationshipStrength[commercial.customerAnalysis.relationshipStrength] || 0;
            marketScore += OPTIONS.marketingPlanEvaluation[commercial.salesStrategy.marketingPlanEvaluation] || 0;
            marketScore += OPTIONS.pricingStrategy[commercial.salesStrategy.pricingStrategy] || 0;
            scores.market = (marketScore / maxMarketScore) * 100;

            // --- Management Quality (15%) ---
            let managementScore = 0;
            const hr = farmAssessmentData.hrManagement;
            const maxManagementBaseScore = 500; 

            managementScore += OPTIONS.organizationalChart[hr.organizationStructure.organizationalChart] || 0;
            managementScore += OPTIONS.roleClarity[hr.organizationStructure.roleClarity] || 0;
            managementScore += ((hr.organizationStructure.keyPersonnel[0] && hr.organizationStructure.keyPersonnel[0].competencyScore) || 0) * 20; 
            managementScore += OPTIONS.successionPlanning[getNestedValue(hr, 'managementCompetency.successionPlanning')] || 0;
            managementScore += OPTIONS.unionRelationships[hr.laborRelations.unionRelationships] || 0;
            
            // Simplified SWOT integration (placeholder for the complex SWOT logic in 39, assuming checkbox data might be missing in 42 structure)
            scores.management = (managementScore / maxManagementBaseScore) * 100;

            // --- Compliance and Risk Management (10%) ---
            let complianceScore = 0;
            const legal = farmAssessmentData.legalCompliance;
            const env = farmAssessmentData.environmentalAssessment;
            const maxComplianceBaseScore = 1200;

            complianceScore += OPTIONS.registrationStatus[legal.corporateCompliance.registrationStatus] || 0;
            complianceScore += (legal.corporateCompliance.directorCompliance ? 100 : 0);
            complianceScore += (legal.corporateCompliance.governanceScore || 0) * 20;
            complianceScore += (legal.complianceCertification.regulatoryStandardsCompliance ? 100 : 0);
            complianceScore += (legal.taxCompliance.incomeTax ? 100 : 0);
            complianceScore += (legal.taxCompliance.vat ? 100 : 0);
            complianceScore += (legal.taxCompliance.paye ? 100 : 0);
            complianceScore += (legal.taxCompliance.municipalTaxes ? 100 : 0);
            complianceScore += OPTIONS.coverageAdequacy[legal.insurancePortfolio.coverageAdequacy] || 0;
            complianceScore += OPTIONS.environmentalAudits[env.regulatoryCompliance.environmentalAudits] || 0;
            complianceScore += OPTIONS.complianceStatus[env.permitsLicenses.complianceStatus] || 0;
            complianceScore += OPTIONS.safetyProtocols[env.hazardousSubstances.safetyProtocols] || 0;
            complianceScore += OPTIONS.waterUsageMonitoring[env.resourceManagement.waterUsage] || 0;
            complianceScore += (env.sustainabilityPractices.renewableEnergy ? 100 : 0);
            complianceScore += OPTIONS.carbonFootprint[env.sustainabilityPractices.carbonFootprint] || 0;
            scores.compliance = (complianceScore / maxComplianceBaseScore) * 100;

            // --- Agricultural and Technical Excellence (10%) ---
            let agriculturalScore = 0;
            const agTech = farmAssessmentData.agriculturalTechnical;
            const maxAgriculturalScore = 1100;

            agriculturalScore += OPTIONS.soilPotential[agTech.landUtilization.soilPotential] || 0;
            agriculturalScore += (agTech.waterResources.irrigationEfficiency || 0);
            agriculturalScore += OPTIONS.waterAvailability[agTech.waterResources.availability] || 0;
            agriculturalScore += OPTIONS.breedSelection[agTech.livestockManagement.breedSelection] || 0;
            agriculturalScore += (agTech.livestockManagement.breedingPrograms.successRate || 0);
            agriculturalScore += OPTIONS.integratedNutritionSystems[agTech.livestockManagement.nutritionPrograms.integratedNutritionSystems] || 0;
            agriculturalScore += OPTIONS.grazingManagement[agTech.livestockManagement.grazingManagement.landUseOptimization] || 0;
            agriculturalScore += OPTIONS.veterinaryPrograms[agTech.livestockManagement.animalHealth.veterinaryPrograms] || 0;
            agriculturalScore += OPTIONS.condition[getNestedValue(agTech, 'livestockManagement.animalHousing.condition')] || 0;
            agriculturalScore += (agTech.productionEfficiency.calvingRate || 0);
            agriculturalScore += (agTech.technologyAdoption.precisionAgriculture ? 100 : 0);
            agriculturalScore += OPTIONS.automationLevel[agTech.technologyAdoption.automationLevel] || 0;
            scores.agricultural = (agriculturalScore / maxAgriculturalScore) * 100;

            // Weighted Total
            const weighted = 
                (scores.financial * COMPONENT_WEIGHTS.financial) + 
                (scores.operational * COMPONENT_WEIGHTS.operational) + 
                (scores.market * COMPONENT_WEIGHTS.market) + 
                (scores.management * COMPONENT_WEIGHTS.management) + 
                (scores.compliance * COMPONENT_WEIGHTS.compliance) + 
                (scores.agricultural * COMPONENT_WEIGHTS.agricultural);
            
            farmAssessmentData.scoring.weightedScore = weighted;

            if (weighted >= 80) {
                farmAssessmentData.scoring.classification = 'Highly Viable';
            } else if (weighted >= 60) {
                farmAssessmentData.scoring.classification = 'Viable with Conditions';
            } else if (weighted >= 40) {
                farmAssessmentData.scoring.classification = 'Marginal Viability';
            } else {
                farmAssessmentData.scoring.classification = 'Non-Viable';
            }

            farmAssessmentData.recommendations.viabilityConclusion = farmAssessmentData.scoring.classification;
            saveCurrentFarmData();
            renderModule('scoring-classification');
            showStatus('Overall score calculated successfully.');
        }

        function updateModuleProgress(moduleName) {
            let progress = 0;
            switch (moduleName) {
                case 'executive-summary':
                    progress = farmAssessmentData.farmProfile.basicInfo.farmName ? 100 : 0;
                    break;
                case 'financial-assessment':
                    const histData = farmAssessmentData.financialAssessment.historicalData.year3;
                    const ratios = farmAssessmentData.financialAssessment.financialRatios;
                    if (histData.revenue > 0 && ratios.currentRatio > 0) progress = 100;
                    else if (histData.revenue > 0) progress = 50;
                    else progress = 0;
                    break;
                case 'commercial-marketing':
                    progress = farmAssessmentData.commercialAssessment.customerAnalysis.customerConcentration > 0 ? 100 : 0;
                    break;
                case 'agricultural-technical':
                    progress = farmAssessmentData.agriculturalTechnical.productionEfficiency.calvingRate > 0 ? 100 : 0;
                    break;
                case 'risk-analysis':
                    const hasRiskData = Object.values(farmAssessmentData.riskAssessment.productionRisks).some(r => r.likelihood > 0 || r.impact > 0);
                    progress = hasRiskData ? 100 : 0;
                    break;
                case 'scoring-classification':
                    progress = farmAssessmentData.scoring.weightedScore > 0 ? 100 : 0;
                    break;
                case 'reporting-system':
                    progress = farmAssessmentData.scoring.weightedScore > 0 ? 100 : 0;
                    break;
                default:
                    progress = 50;
            }

            const badge = document.getElementById(`progress-${moduleName}`);
            const mobileBadge = document.getElementById(`progress-${moduleName}-mobile`);

            [badge, mobileBadge].forEach(element => {
                if (element) {
                    element.textContent = `${Math.round(progress)}%`;
                    element.className = `float-end badge ${progress === 100 ? 'bg-success' : progress > 0 ? 'bg-warning' : 'bg-secondary'}`;
                }
            });
        }

        function updateAllModuleProgress() {
            ['executive-summary', 'business-description', 'financial-assessment', 'commercial-marketing', 'hr-management', 'environmental-assessment', 'legal-regulatory', 'agricultural-technical', 'risk-analysis', 'scoring-classification', 'viability-conclusion', 'reporting-system'].forEach(module => {
                updateModuleProgress(module);
            });
        }

        // ============================================
        // IMPORT/EXPORT & EMERGENCY RECOVERY
        // ============================================

        async function exportAllData() {
            try {
                showLoading();
                const db = await openIndexedDB();
                const allData = {};

                for (const farmId of allFarmIds) {
                    const data = await loadFarmDataIndexedDB(farmId);
                    allData[farmId] = data;
                }

                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    farms: allData
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `farm-assessment-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                hideLoading();
                showStatus('Data exported successfully.');
            } catch (error) {
                hideLoading();
                console.error('Export error:', error);
                showStatus('Error exporting data: ' + error.message, true);
            }
        }

        async function importData(file) {
            try {
                showLoading();
                const fileContent = await file.text();
                const importedData = JSON.parse(fileContent);

                // Handle both the single recovery file format (array) and the full backup format (object with farms)
                let farmsToImport = [];
                
                if (Array.isArray(importedData)) {
                    // Recovery format
                    farmsToImport = importedData; 
                } else if (importedData.farms && typeof importedData.farms === 'object') {
                    // Standard export format
                    farmsToImport = Object.keys(importedData.farms).map(key => ({
                        farmId: key,
                        data: importedData.farms[key]
                    }));
                } else {
                    throw new Error('Invalid file format.');
                }

                let importedCount = 0;
                for (const item of farmsToImport) {
                    const fId = item.farmId;
                    const fData = item.data;
                    await saveFarmDataIndexedDB(fId, fData);
                    if (!allFarmIds.includes(fId)) {
                        allFarmIds.push(fId);
                    }
                    importedCount++;
                }

                if (allFarmIds.length > 0) {
                    await loadFarm(allFarmIds[0]);
                    updateAllModuleProgress();
                }

                hideLoading();
                showStatus(`Successfully imported ${importedCount} farm(s).`);
            } catch (error) {
                hideLoading();
                console.error('Import error:', error);
                showStatus('Error importing data: ' + error.message, true);
            }
        }

        async function forceCoughUpData() {
            console.log("%c--- EMERGENCY DATA RECOVERY STARTED ---", "color: red; font-weight: bold; font-size: 16px;");
            showLoading();
            try {
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject("Failed to open database: " + request.error);
                });

                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    throw new Error(`Object store "${STORE_NAME}" not found in database "${DB_NAME}".`);
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = async () => {
                    const allData = request.result;
                    hideLoading();
                    console.log(`%cSuccess! Found ${allData.length} records.`, "color: green; font-weight: bold;");
                    
                    if (allData.length === 0) {
                        alert("No data found in the local database.");
                        return;
                    }

                    // 1. Always trigger the download first as a safety backup
                    const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `recovered_farm_data_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // 2. Ask user if they want to load the data into the app immediately
                    const shouldImport = confirm(`Found ${allData.length} records. A backup file has been downloaded.\n\nWould you like to IMPORT this data into the app right now for immediate use? (This will refresh your farm list)`);
                    
                    if (shouldImport) {
                        showLoading();
                        try {
                            // Update the global list of farm IDs
                            allFarmIds = allData.map(item => item.farmId);
                            
                            // Load the first farm from the recovered set
                            if (allFarmIds.length > 0) {
                                await loadFarm(allFarmIds[0]);
                                updateFarmSelector();
                                showStatus(`Successfully imported ${allData.length} farms.`);
                                alert(`Success! ${allData.length} farms have been loaded into the app.`);
                            }
                        } catch (importError) {
                            console.error("Import failed:", importError);
                            alert("Failed to import data into the app: " + importError.message);
                        } finally {
                            hideLoading();
                        }
                    } else {
                        showStatus('Recovery complete. Backup file downloaded.');
                    }
                };

                request.onerror = () => {
                    hideLoading();
                    throw new Error("Failed to retrieve data: " + request.error);
                };

            } catch (error) {
                hideLoading();
                console.error("%cRECOVERY FAILED:", "color: red; font-weight: bold;", error);
                alert("Recovery failed: " + error.message);
            }
        }

        // ============================================
        // INITIALIZATION ON PAGE LOAD
        // ============================================

        document.addEventListener('DOMContentLoaded', async () => {
            showLoading();

            try {
                await openIndexedDB();
                allFarmIds = await getAllFarmIdsIndexedDB();

                let lastUsedFarmId = getLastUsedFarmId();
                let farmToLoad = null;

                if (lastUsedFarmId && allFarmIds.includes(lastUsedFarmId)) {
                    farmToLoad = lastUsedFarmId;
                } else if (allFarmIds.length > 0) {
                    farmToLoad = allFarmIds[0];
                } else {
                    await createNewFarm();
                    hideLoading();
                    return;
                }

                await loadFarm(farmToLoad);
                updateAllModuleProgress();
            } catch (error) {
                console.error('Initialization error:', error);
                showStatus('Error initializing application', true);
            } finally {
                hideLoading();
            }
        });

        // Event listeners for main buttons
        document.getElementById('farmSelector').addEventListener('change', async (e) => {
            if (e.target.value) {
                await loadFarm(e.target.value);
                updateAllModuleProgress();
            }
        });

        document.getElementById('newFarmBtn').addEventListener('click', createNewFarm);
        document.getElementById('deleteFarmBtn').addEventListener('click', deleteCurrentFarm);
        
        // Emergency Recovery Button Listener
        document.getElementById('emergencyRecoveryBtn').addEventListener('click', async () => {
            if (confirm('This will attempt to extract all stored data from the browser\'s local database and download it as a JSON file. Use this if you are unable to access your data normally. Continue?')) {
                await forceCoughUpData();
            }
        });

        // Export/Import button listeners
        const exportBtn = document.getElementById('exportDataBtn');
        const importBtn = document.getElementById('importDataBtn');
        const exportBtnMobile = document.getElementById('exportDataBtnMobile');
        const importBtnMobile = document.getElementById('importDataBtnMobile');
        const importFileInput = document.getElementById('importFileInput');

        if (exportBtn) exportBtn.addEventListener('click', (e) => { e.preventDefault(); exportAllData(); });
        if (importBtn) importBtn.addEventListener('click', (e) => { e.preventDefault(); importFileInput.click(); });
        if (exportBtnMobile) exportBtnMobile.addEventListener('click', (e) => { e.preventDefault(); exportAllData(); });
        if (importBtnMobile) importBtnMobile.addEventListener('click', (e) => { e.preventDefault(); importFileInput.click(); });

        importFileInput.addEventListener('change', async (e) => {
            if (e.target.files && e.target.files[0]) {
                await importData(e.target.files[0]);
                e.target.value = ''; // Reset file input
            }
        });

        // Sidebar navigation
        document.querySelectorAll('.sidebar .nav-link, .offcanvas-body .nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const moduleName = link.dataset.module;
                document.querySelectorAll('.sidebar .nav-link, .offcanvas-body .nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector(`.sidebar .nav-link[data-module="${moduleName}"]`)?.classList.add('active');
                document.querySelector(`.offcanvas-body .nav-link[data-module="${moduleName}"]`)?.classList.add('active');
                renderModule(moduleName);
            });
        });
    </script>
</body>
</html>
